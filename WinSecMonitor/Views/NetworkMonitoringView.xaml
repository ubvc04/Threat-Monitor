<UserControl x:Class="WinSecMonitor.Views.NetworkMonitoringView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
             xmlns:local="clr-namespace:WinSecMonitor.Views"
             xmlns:network="clr-namespace:WinSecMonitor.Modules.Network"
             mc:Ignorable="d" 
             d:DesignHeight="600" d:DesignWidth="800">
    
    <UserControl.Resources>
        <!-- Styles for DataGrid rows based on alert severity -->
        <Style x:Key="HighSeverityRow" TargetType="DataGridRow">
            <Setter Property="Background" Value="#FFDDDD" />
            <Setter Property="FontWeight" Value="Bold" />
        </Style>
        <Style x:Key="MediumSeverityRow" TargetType="DataGridRow">
            <Setter Property="Background" Value="#FFFFDD" />
        </Style>
        <Style x:Key="LowSeverityRow" TargetType="DataGridRow">
            <Setter Property="Background" Value="#DDFFDD" />
        </Style>
        
        <!-- Converter for alert severity to row style -->
        <local:AlertSeverityToStyleConverter x:Key="AlertSeverityToStyleConverter" 
                                           HighSeverityStyle="{StaticResource HighSeverityRow}"
                                           MediumSeverityStyle="{StaticResource MediumSeverityRow}"
                                           LowSeverityStyle="{StaticResource LowSeverityRow}" />
    </UserControl.Resources>
    
    <Grid>
        <TabControl>
            <!-- Network Connections Tab -->
            <TabItem Header="Network Connections">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>
                    
                    <!-- Controls Panel -->
                    <StackPanel Grid.Row="0" Orientation="Horizontal" Margin="5">
                        <Button x:Name="btnStartMonitoring" Content="Start Monitoring" Margin="5" Padding="5,2" 
                                Command="{Binding StartMonitoringCommand}" />
                        <Button x:Name="btnStopMonitoring" Content="Stop Monitoring" Margin="5" Padding="5,2" 
                                Command="{Binding StopMonitoringCommand}" />
                        <Button x:Name="btnRefresh" Content="Refresh" Margin="5" Padding="5,2" 
                                Command="{Binding RefreshConnectionsCommand}" />
                        <TextBlock Text="Search:" VerticalAlignment="Center" Margin="10,0,0,0"/>
                        <TextBox x:Name="txtConnectionSearch" Width="150" Margin="5" 
                                 Text="{Binding ConnectionSearchText, UpdateSourceTrigger=PropertyChanged}" />
                        <ComboBox x:Name="cmbConnectionFilter" Width="120" Margin="5" 
                                  ItemsSource="{Binding ConnectionFilterOptions}" 
                                  SelectedItem="{Binding SelectedConnectionFilter}" />
                    </StackPanel>
                    
                    <!-- Connections DataGrid -->
                    <DataGrid Grid.Row="1" x:Name="dgConnections" Margin="5" 
                              ItemsSource="{Binding FilteredConnections}" 
                              AutoGenerateColumns="False" IsReadOnly="True"
                              AlternatingRowBackground="#F5F5F5"
                              CanUserSortColumns="True"
                              CanUserResizeColumns="True"
                              CanUserReorderColumns="True"
                              SelectionMode="Single">
                        <DataGrid.Columns>
                            <DataGridTextColumn Header="Protocol" Binding="{Binding Protocol}" Width="70" />
                            <DataGridTextColumn Header="Local Address" Binding="{Binding LocalAddress}" Width="120" />
                            <DataGridTextColumn Header="Local Port" Binding="{Binding LocalPort}" Width="80" />
                            <DataGridTextColumn Header="Remote Address" Binding="{Binding RemoteAddress}" Width="120" />
                            <DataGridTextColumn Header="Remote Host" Binding="{Binding RemoteHostName}" Width="150" />
                            <DataGridTextColumn Header="Remote Port" Binding="{Binding RemotePort}" Width="80" />
                            <DataGridTextColumn Header="State" Binding="{Binding State}" Width="100" />
                            <DataGridTextColumn Header="Process" Binding="{Binding ProcessName}" Width="120" />
                            <DataGridTextColumn Header="PID" Binding="{Binding ProcessId}" Width="60" />
                            <DataGridTextColumn Header="Service" Binding="{Binding ServiceName}" Width="120" />
                        </DataGrid.Columns>
                        <DataGrid.RowStyle>
                            <Style TargetType="DataGridRow">
                                <Style.Triggers>
                                    <DataTrigger Binding="{Binding IsSuspicious}" Value="True">
                                        <Setter Property="Background" Value="#FFDDDD" />
                                        <Setter Property="FontWeight" Value="Bold" />
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </DataGrid.RowStyle>
                        <DataGrid.ContextMenu>
                            <ContextMenu>
                                <MenuItem Header="Add IP to Blacklist" 
                                          Command="{Binding AddToBlacklistCommand}" 
                                          CommandParameter="{Binding RelativeSource={RelativeSource AncestorType=ContextMenu}, Path=PlacementTarget.SelectedItem}" />
                                <MenuItem Header="Add IP to Whitelist" 
                                          Command="{Binding AddToWhitelistCommand}" 
                                          CommandParameter="{Binding RelativeSource={RelativeSource AncestorType=ContextMenu}, Path=PlacementTarget.SelectedItem}" />
                                <Separator />
                                <MenuItem Header="Copy IP Address" 
                                          Command="{Binding CopyIpAddressCommand}" 
                                          CommandParameter="{Binding RelativeSource={RelativeSource AncestorType=ContextMenu}, Path=PlacementTarget.SelectedItem}" />
                            </ContextMenu>
                        </DataGrid.ContextMenu>
                    </DataGrid>
                </Grid>
            </TabItem>
            
            <!-- Alerts Tab -->
            <TabItem Header="Network Alerts">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>
                    
                    <!-- Controls Panel -->
                    <StackPanel Grid.Row="0" Orientation="Horizontal" Margin="5">
                        <Button x:Name="btnClearAlerts" Content="Clear Alerts" Margin="5" Padding="5,2" 
                                Command="{Binding ClearAlertsCommand}" />
                        <Button x:Name="btnExportAlerts" Content="Export to CSV" Margin="5" Padding="5,2" 
                                Command="{Binding ExportAlertsToCsvCommand}" />
                        <TextBlock Text="Search:" VerticalAlignment="Center" Margin="10,0,0,0"/>
                        <TextBox x:Name="txtAlertSearch" Width="150" Margin="5" 
                                 Text="{Binding AlertSearchText, UpdateSourceTrigger=PropertyChanged}" />
                        <ComboBox x:Name="cmbAlertSeverityFilter" Width="120" Margin="5" 
                                  ItemsSource="{Binding AlertSeverityFilterOptions}" 
                                  SelectedItem="{Binding SelectedAlertSeverityFilter}" />
                    </StackPanel>
                    
                    <!-- Alerts DataGrid -->
                    <DataGrid Grid.Row="1" x:Name="dgAlerts" Margin="5" 
                              ItemsSource="{Binding FilteredAlerts}" 
                              AutoGenerateColumns="False" IsReadOnly="True"
                              AlternatingRowBackground="#F5F5F5"
                              CanUserSortColumns="True"
                              CanUserResizeColumns="True"
                              CanUserReorderColumns="True"
                              SelectionMode="Single">
                        <DataGrid.Columns>
                            <DataGridTextColumn Header="Time" Binding="{Binding Timestamp, StringFormat='{}{0:yyyy-MM-dd HH:mm:ss}'}" Width="140" />
                            <DataGridTextColumn Header="Severity" Binding="{Binding Severity}" Width="80" />
                            <DataGridTextColumn Header="Type" Binding="{Binding AlertType}" Width="120" />
                            <DataGridTextColumn Header="Description" Binding="{Binding Description}" Width="*" />
                            <DataGridTextColumn Header="IP Address" Binding="{Binding IpAddress}" Width="120" />
                            <DataGridTextColumn Header="Port" Binding="{Binding Port}" Width="60" />
                            <DataGridTextColumn Header="Process" Binding="{Binding ProcessName}" Width="120" />
                            <DataGridTextColumn Header="PID" Binding="{Binding ProcessId}" Width="60" />
                        </DataGrid.Columns>
                        <DataGrid.RowStyle>
                            <Style TargetType="DataGridRow">
                                <Style.Triggers>
                                    <DataTrigger Binding="{Binding Severity}" Value="High">
                                        <Setter Property="Background" Value="#FFDDDD" />
                                        <Setter Property="FontWeight" Value="Bold" />
                                    </DataTrigger>
                                    <DataTrigger Binding="{Binding Severity}" Value="Medium">
                                        <Setter Property="Background" Value="#FFFFDD" />
                                    </DataTrigger>
                                    <DataTrigger Binding="{Binding Severity}" Value="Critical">
                                        <Setter Property="Background" Value="#FF9999" />
                                        <Setter Property="FontWeight" Value="Bold" />
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </DataGrid.RowStyle>
                        <DataGrid.ContextMenu>
                            <ContextMenu>
                                <MenuItem Header="Add IP to Blacklist" 
                                          Command="{Binding AddAlertIpToBlacklistCommand}" 
                                          CommandParameter="{Binding RelativeSource={RelativeSource AncestorType=ContextMenu}, Path=PlacementTarget.SelectedItem}" />
                                <MenuItem Header="Add IP to Whitelist" 
                                          Command="{Binding AddAlertIpToWhitelistCommand}" 
                                          CommandParameter="{Binding RelativeSource={RelativeSource AncestorType=ContextMenu}, Path=PlacementTarget.SelectedItem}" />
                                <Separator />
                                <MenuItem Header="Copy IP Address" 
                                          Command="{Binding CopyAlertIpAddressCommand}" 
                                          CommandParameter="{Binding RelativeSource={RelativeSource AncestorType=ContextMenu}, Path=PlacementTarget.SelectedItem}" />
                            </ContextMenu>
                        </DataGrid.ContextMenu>
                    </DataGrid>
                </Grid>
            </TabItem>
            
            <!-- Configuration Tab -->
            <TabItem Header="Configuration">
                <ScrollViewer VerticalScrollBarVisibility="Auto">
                    <StackPanel Margin="10">
                        <!-- General Settings -->
                        <GroupBox Header="General Settings" Margin="0,5,0,10">
                            <Grid Margin="5">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="Auto"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                </Grid.RowDefinitions>
                                
                                <TextBlock Grid.Row="0" Grid.Column="0" Text="Refresh Interval (seconds):" 
                                           VerticalAlignment="Center" Margin="0,5,10,5"/>
                                <StackPanel Grid.Row="0" Grid.Column="1" Orientation="Horizontal">
                                    <Slider x:Name="sldRefreshInterval" Minimum="1" Maximum="60" 
                                            Value="{Binding RefreshInterval}" Width="200" 
                                            VerticalAlignment="Center" />
                                    <TextBlock Text="{Binding RefreshInterval}" Margin="10,0,0,0" 
                                               VerticalAlignment="Center" MinWidth="20"/>
                                </StackPanel>
                                
                                <TextBlock Grid.Row="1" Grid.Column="0" Text="Maximum Alerts:" 
                                           VerticalAlignment="Center" Margin="0,5,10,5"/>
                                <StackPanel Grid.Row="1" Grid.Column="1" Orientation="Horizontal">
                                    <Slider x:Name="sldMaxAlerts" Minimum="100" Maximum="10000" SmallChange="100" LargeChange="1000"
                                            Value="{Binding MaxAlerts}" Width="200" 
                                            VerticalAlignment="Center" />
                                    <TextBlock Text="{Binding MaxAlerts}" Margin="10,0,0,0" 
                                               VerticalAlignment="Center" MinWidth="40"/>
                                </StackPanel>
                            </Grid>
                        </GroupBox>
                        
                        <!-- IP Blacklist/Whitelist Management -->
                        <GroupBox Header="IP Management" Margin="0,5,0,10">
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>
                                
                                <!-- Blacklist -->
                                <GroupBox Grid.Column="0" Header="Blacklisted IPs" Margin="5">
                                    <Grid>
                                        <Grid.RowDefinitions>
                                            <RowDefinition Height="Auto"/>
                                            <RowDefinition Height="*"/>
                                            <RowDefinition Height="Auto"/>
                                        </Grid.RowDefinitions>
                                        
                                        <StackPanel Grid.Row="0" Orientation="Horizontal" Margin="0,5">
                                            <TextBox x:Name="txtAddBlacklist" Width="150" Margin="0,0,5,0" 
                                                     Text="{Binding NewBlacklistIp, UpdateSourceTrigger=PropertyChanged}"/>
                                            <Button Content="Add" Padding="10,0" 
                                                    Command="{Binding AddToBlacklistManualCommand}" 
                                                    CommandParameter="{Binding NewBlacklistIp}"/>
                                        </StackPanel>
                                        
                                        <ListBox Grid.Row="1" x:Name="lstBlacklist" Margin="0,5" Height="150"
                                                 ItemsSource="{Binding BlacklistedIps}">
                                            <ListBox.ContextMenu>
                                                <ContextMenu>
                                                    <MenuItem Header="Remove" 
                                                              Command="{Binding RemoveFromBlacklistCommand}" 
                                                              CommandParameter="{Binding RelativeSource={RelativeSource AncestorType=ContextMenu}, Path=PlacementTarget.SelectedItem}"/>
                                                </ContextMenu>
                                            </ListBox.ContextMenu>
                                        </ListBox>
                                        
                                        <StackPanel Grid.Row="2" Orientation="Horizontal" Margin="0,5">
                                            <Button Content="Load from File" Margin="0,0,5,0" Padding="5,2"
                                                    Command="{Binding LoadBlacklistFromFileCommand}"/>
                                            <Button Content="Save to File" Padding="5,2"
                                                    Command="{Binding SaveBlacklistToFileCommand}"/>
                                        </StackPanel>
                                    </Grid>
                                </GroupBox>
                                
                                <!-- Whitelist -->
                                <GroupBox Grid.Column="1" Header="Whitelisted IPs" Margin="5">
                                    <Grid>
                                        <Grid.RowDefinitions>
                                            <RowDefinition Height="Auto"/>
                                            <RowDefinition Height="*"/>
                                            <RowDefinition Height="Auto"/>
                                        </Grid.RowDefinitions>
                                        
                                        <StackPanel Grid.Row="0" Orientation="Horizontal" Margin="0,5">
                                            <TextBox x:Name="txtAddWhitelist" Width="150" Margin="0,0,5,0" 
                                                     Text="{Binding NewWhitelistIp, UpdateSourceTrigger=PropertyChanged}"/>
                                            <Button Content="Add" Padding="10,0" 
                                                    Command="{Binding AddToWhitelistManualCommand}" 
                                                    CommandParameter="{Binding NewWhitelistIp}"/>
                                        </StackPanel>
                                        
                                        <ListBox Grid.Row="1" x:Name="lstWhitelist" Margin="0,5" Height="150"
                                                 ItemsSource="{Binding WhitelistedIps}">
                                            <ListBox.ContextMenu>
                                                <ContextMenu>
                                                    <MenuItem Header="Remove" 
                                                              Command="{Binding RemoveFromWhitelistCommand}" 
                                                              CommandParameter="{Binding RelativeSource={RelativeSource AncestorType=ContextMenu}, Path=PlacementTarget.SelectedItem}"/>
                                                </ContextMenu>
                                            </ListBox.ContextMenu>
                                        </ListBox>
                                        
                                        <StackPanel Grid.Row="2" Orientation="Horizontal" Margin="0,5">
                                            <Button Content="Load from File" Margin="0,0,5,0" Padding="5,2"
                                                    Command="{Binding LoadWhitelistFromFileCommand}"/>
                                            <Button Content="Save to File" Padding="5,2"
                                                    Command="{Binding SaveWhitelistToFileCommand}"/>
                                        </StackPanel>
                                    </Grid>
                                </GroupBox>
                            </Grid>
                        </GroupBox>
                        
                        <!-- Malicious Domains Management -->
                        <GroupBox Header="Malicious Domains" Margin="0,5,0,10">
                            <Grid>
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="*"/>
                                    <RowDefinition Height="Auto"/>
                                </Grid.RowDefinitions>
                                
                                <StackPanel Grid.Row="0" Orientation="Horizontal" Margin="5">
                                    <TextBox x:Name="txtAddMaliciousDomain" Width="200" Margin="0,0,5,0" 
                                             Text="{Binding NewMaliciousDomain, UpdateSourceTrigger=PropertyChanged}"/>
                                    <Button Content="Add" Padding="10,0" 
                                            Command="{Binding AddMaliciousDomainCommand}" 
                                            CommandParameter="{Binding NewMaliciousDomain}"/>
                                </StackPanel>
                                
                                <ListBox Grid.Row="1" x:Name="lstMaliciousDomains" Margin="5" Height="150"
                                         ItemsSource="{Binding MaliciousDomains}">
                                    <ListBox.ContextMenu>
                                        <ContextMenu>
                                            <MenuItem Header="Remove" 
                                                      Command="{Binding RemoveMaliciousDomainCommand}" 
                                                      CommandParameter="{Binding RelativeSource={RelativeSource AncestorType=ContextMenu}, Path=PlacementTarget.SelectedItem}"/>
                                        </ContextMenu>
                                    </ListBox.ContextMenu>
                                </ListBox>
                                
                                <StackPanel Grid.Row="2" Orientation="Horizontal" Margin="5">
                                    <Button Content="Load from File" Margin="0,0,5,0" Padding="5,2"
                                            Command="{Binding LoadMaliciousDomainsFromFileCommand}"/>
                                    <Button Content="Save to File" Padding="5,2"
                                            Command="{Binding SaveMaliciousDomainsToFileCommand}"/>
                                </StackPanel>
                            </Grid>
                        </GroupBox>
                    </StackPanel>
                </ScrollViewer>
            </TabItem>
        </TabControl>
    </Grid>
</UserControl>